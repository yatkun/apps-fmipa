<?php

namespace App\Services;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Storage;
use App\Models\Letter;

class TelegramNotificationSer        // Get user's telegram chat ID
        $userChatId = $letter->creator->telegram_chat_id;
        
        // Send notification message first
        $message = "ðŸŽ‰ *SURAT DISETUJUI DEKAN*\n\n";
        $message .= "ðŸ“„ *Judul:* {$letter->title}\n";
        $message .= "ðŸ“‹ *No. Surat:* `{$noSurat}`\n";
        $message .= "ðŸ‘¤ *Pengaju:* {$letter->creator->name}\n";
        $message .= "ðŸ‘¨â€ðŸ’¼ *Disetujui oleh:* {$letter->dekanVerifier->name}\n";
        
        if ($letter->dekan_notes) {
            $message .= "ðŸ“ *Catatan:* {$letter->dekan_notes}\n";
        }
        
        $message .= "ðŸ“… *Tanggal Persetujuan:* " . $letter->verified_at_dekan->format('d M Y H:i') . "\n";
        $message .= "âœ… *Status:* DISETUJUI\n\n";
        $message .= "ðŸ“„ Dokumen surat akan dikirim berikutnya...";

        // Send to user's personal chat if available, otherwise send to default group
        $targetChatId = $userChatId ?: null;
        $messageResult = $this->sendMessage($message, 'Markdown', $targetChatId);
        
        // Also send to default group chat for monitoring
        if ($userChatId) {
            $groupMessage = "ðŸ“¢ *NOTIFIKASI GRUP*\n\n";
            $groupMessage .= "ðŸŽ‰ Surat telah disetujui Dekan dan dikirim ke pengguna\n";
            $groupMessage .= "ðŸ‘¤ *Pengguna:* {$letter->creator->name}\n";
            $groupMessage .= "ðŸ“„ *Judul:* {$letter->title}\n";
            $groupMessage .= "ðŸ“‹ *No. Surat:* `{$noSurat}`\n";
            $this->sendMessage($groupMessage);
        }te $botToken;
    private $chatId;

    public function __construct()
    {
        $this->botToken = env('TELEGRAM_BOT_TOKEN', '8446128745:AAGRBVniJe6PGWjSBrZvyZpHJnDLmqrjPrc');
        $this->chatId = env('TELEGRAM_CHAT_ID', '1943944168');
    }

    public function sendMessage($message, $parseMode = 'Markdown', $customChatId = null)
    {
        try {
            $url = "https://api.telegram.org/bot{$this->botToken}/sendMessage";
            $chatId = $customChatId ?? $this->chatId;
            
            $response = Http::post($url, [
                'chat_id' => $chatId,
                'text' => $message,
                'parse_mode' => $parseMode,
                'disable_web_page_preview' => true
            ]);

            if ($response->successful()) {
                Log::info('Telegram notification sent successfully', [
                    'chat_id' => $chatId,
                    'custom_chat' => $customChatId ? true : false
                ]);
                return true;
            } else {
                Log::error('Failed to send Telegram notification', [
                    'chat_id' => $chatId,
                    'response' => $response->json()
                ]);
                return false;
            }
        } catch (\Exception $e) {
            Log::error('Telegram notification error: ' . $e->getMessage());
            return false;
        }
    }

    public function sendDocument($filePath, $caption = '', $parseMode = 'Markdown', $customChatId = null)
    {
        try {
            $url = "https://api.telegram.org/bot{$this->botToken}/sendDocument";
            $chatId = $customChatId ?? $this->chatId;
            
            // Validasi file exists
            if (!file_exists($filePath)) {
                Log::error('File not found for Telegram document send', ['file_path' => $filePath]);
                return false;
            }

            // Validasi ukuran file (max 50MB untuk Telegram)
            $fileSize = filesize($filePath);
            if ($fileSize > 50 * 1024 * 1024) {
                Log::error('File too large for Telegram (max 50MB)', [
                    'file_path' => $filePath,
                    'file_size' => $fileSize
                ]);
                return false;
            }

            // Kirim dokumen menggunakan multipart
            $response = Http::attach(
                'document', file_get_contents($filePath), basename($filePath)
            )->post($url, [
                'chat_id' => $chatId,
                'caption' => $caption,
                'parse_mode' => $parseMode
            ]);

            if ($response->successful()) {
                Log::info('Telegram document sent successfully', [
                    'chat_id' => $chatId,
                    'file_path' => $filePath,
                    'file_size' => $fileSize,
                    'custom_chat' => $customChatId ? true : false
                ]);
                return true;
            } else {
                Log::error('Failed to send Telegram document', [
                    'chat_id' => $chatId,
                    'file_path' => $filePath,
                    'response' => $response->json()
                ]);
                return false;
            }
        } catch (\Exception $e) {
            Log::error('Telegram document send error: ' . $e->getMessage(), [
                'file_path' => $filePath
            ]);
            return false;
        }
    }

    public function sendDocumentFromGoogleDrive($googleDrivePath, $caption = '', $parseMode = 'Markdown', $customChatId = null)
    {
        try {
            // Download file from Google Drive to temporary location
            if (!Storage::disk('google')->exists($googleDrivePath)) {
                Log::error('File not found in Google Drive', ['path' => $googleDrivePath]);
                return false;
            }

            $content = Storage::disk('google')->get($googleDrivePath);
            
            // Create temporary file
            $tempFileName = 'temp_telegram_' . time() . '_' . basename($googleDrivePath);
            $tempFilePath = storage_path('app/temp/' . $tempFileName);
            
            // Ensure temp directory exists
            if (!file_exists(dirname($tempFilePath))) {
                mkdir(dirname($tempFilePath), 0755, true);
            }
            
            // Save content to temp file
            if (file_put_contents($tempFilePath, $content) === false) {
                Log::error('Failed to create temporary file for Telegram send');
                return false;
            }

            // Send document
            $result = $this->sendDocument($tempFilePath, $caption, $parseMode, $customChatId);
            
            // Cleanup temporary file
            if (file_exists($tempFilePath)) {
                unlink($tempFilePath);
            }
            
            return $result;
            
        } catch (\Exception $e) {
            Log::error('Telegram Google Drive document send error: ' . $e->getMessage(), [
                'google_drive_path' => $googleDrivePath
            ]);
            return false;
        }
    }

    public function notifyLetterSubmitted(Letter $letter)
    {
        $template = $letter->template ? $letter->template->name : 'Surat Custom';
        
        $message = "ðŸ†• *SURAT BARU DIAJUKAN*\n\n";
        $message .= "ðŸ“„ *Judul:* {$letter->title}\n";
        $message .= "ðŸ“‹ *Template:* {$template}\n";
        $message .= "ðŸ‘¤ *Pengaju:* {$letter->creator->name}\n";
        $message .= "ðŸ¢ *Level:* {$letter->creator->level}\n";
        $message .= "ï¿½ï¿½ *Tanggal:* " . $letter->created_at->format('d M Y H:i') . "\n";
        $message .= "ðŸ”„ *Status:* Menunggu Verifikasi Tendik\n\n";
        $message .= "ðŸ”— [Lihat Detail Surat](" . route('verify.by.tendik', $letter->hashed_id) . ")";

        return $this->sendMessage($message);
    }

    public function notifyLetterVerifiedByTendik(Letter $letter)
    {
        $dataFilled = is_string($letter->data_filled) 
            ? json_decode($letter->data_filled, true) 
            : $letter->data_filled;
        $noSurat = $dataFilled['no_surat'] ?? 'Belum ada nomor';
        
        $message = "âœ… *SURAT DIVERIFIKASI TENDIK*\n\n";
        $message .= "ðŸ“„ *Judul:* {$letter->title}\n";
        $message .= "ðŸ“‹ *No. Surat:* `{$noSurat}`\n";
        $message .= "ðŸ‘¤ *Pengaju:* {$letter->creator->name}\n";
        $message .= "ðŸ›¡ï¸ *Diverifikasi oleh:* {$letter->tendikVerifier->name}\n";
        
        if ($letter->tendik_notes) {
            $message .= "ðŸ“ *Catatan:* {$letter->tendik_notes}\n";
        }
        
        $message .= "ðŸ“… *Tanggal Verifikasi:* " . $letter->verified_at_tendik->format('d M Y H:i') . "\n";
        $message .= "ï¿½ï¿½ *Status:* Menunggu Persetujuan Dekan\n\n";
        $message .= "ðŸ”— [Lihat Detail Surat](" . route('letters.show', $letter->hashed_id) . ")";

        return $this->sendMessage($message);
    }

    public function notifyLetterApprovedByDekan(Letter $letter)
    {
        $dataFilled = is_string($letter->data_filled) 
            ? json_decode($letter->data_filled, true) 
            : $letter->data_filled;
        $noSurat = $dataFilled['no_surat'] ?? 'Belum ada nomor';
        
        // Send notification message first
        $message = "ðŸŽ‰ *SURAT DISETUJUI DEKAN*\n\n";
        $message .= "ðŸ“„ *Judul:* {$letter->title}\n";
        $message .= "ðŸ“‹ *No. Surat:* `{$noSurat}`\n";
        $message .= "ðŸ‘¤ *Pengaju:* {$letter->creator->name}\n";
        $message .= "ðŸ‘¨â€ðŸ’¼ *Disetujui oleh:* {$letter->dekanVerifier->name}\n";
        
        if ($letter->dekan_notes) {
            $message .= "ðŸ“ *Catatan:* {$letter->dekan_notes}\n";
        }
        
        $message .= "ðŸ“… *Tanggal Persetujuan:* " . $letter->verified_at_dekan->format('d M Y H:i') . "\n";
        $message .= "âœ… *Status:* DISETUJUI\n\n";
        $message .= "ï¿½ Dokumen surat akan dikirim berikutnya...";

        $messageResult = $this->sendMessage($message);
        
        // Try to send the document
        $documentResult = false;
        if ($letter->file_path) {
            // Prepare document caption
            $documentCaption = "ðŸ“„ *Surat Disetujui*\n";
            $documentCaption .= "ðŸ·ï¸ {$letter->title}\n";
            $documentCaption .= "ðŸ“‹ No: `{$noSurat}`\n";
            $documentCaption .= "ðŸ‘¤ {$letter->creator->name}\n";
            $documentCaption .= "ðŸ“… " . $letter->verified_at_dekan->format('d M Y');
            
            // Check if file is in Google Drive or local storage
            if (str_starts_with($letter->file_path, 'Surat/')) {
                // File is in Google Drive
                Log::info('Sending document from Google Drive', [
                    'letter_id' => $letter->id,
                    'file_path' => $letter->file_path
                ]);
                $documentResult = $this->sendDocumentFromGoogleDrive($letter->file_path, $documentCaption);
            } else {
                // File is in local storage
                $localFilePath = Storage::disk('public')->path($letter->file_path);
                if (file_exists($localFilePath)) {
                    Log::info('Sending document from local storage', [
                        'letter_id' => $letter->id,
                        'file_path' => $localFilePath
                    ]);
                    $documentResult = $this->sendDocument($localFilePath, $documentCaption);
                } else {
                    Log::warning('Local file not found for document send', [
                        'letter_id' => $letter->id,
                        'file_path' => $localFilePath
                    ]);
                }
            }
            
            // Send fallback message if document send failed
            if (!$documentResult) {
                $fallbackMessage = "âš ï¸ Dokumen tidak dapat dikirim otomatis.\n";
                $fallbackMessage .= "ðŸ”— [Unduh Surat](" . route('letters.show', $letter->hashed_id) . ")";
                $this->sendMessage($fallbackMessage);
            }
        }

        return $messageResult;
    }

    public function notifyLetterRejected(Letter $letter, $rejectedBy = 'Tendik')
    {
        $message = "âŒ *SURAT DITOLAK*\n\n";
        $message .= "ðŸ“„ *Judul:* {$letter->title}\n";
        $message .= "ðŸ‘¤ *Pengaju:* {$letter->creator->name}\n";
        $message .= "ðŸš« *Ditolak oleh:* {$rejectedBy}\n";
        
        if ($letter->rejection_reason) {
            $message .= "ðŸ“ *Alasan Penolakan:* {$letter->rejection_reason}\n";
        }
        
        $message .= "ðŸ“… *Tanggal Penolakan:* " . now()->format('d M Y H:i') . "\n";
        $message .= "ðŸ”„ *Status:* DITOLAK\n\n";
        $message .= "ðŸ”— [Lihat Detail Surat](" . route('letters.show', $letter->hashed_id) . ")";

        return $this->sendMessage($message);
    }

    public function sendDailySummary()
    {
        $today = now()->format('Y-m-d');
        
        $pendingTendik = Letter::where('status', 'verification_tendik')->count();
        $pendingDekan = Letter::where('status', 'verification_dekan')->count();
        $approvedToday = Letter::where('status', 'approved')
            ->whereDate('verified_at_dekan', $today)
            ->count();
        $rejectedToday = Letter::where('status', 'rejected')
            ->whereDate('updated_at', $today)
            ->count();

        $message = "ðŸ“Š *RINGKASAN HARIAN SURAT*\n";
        $message .= "_" . now()->format('d M Y') . "_\n\n";
        $message .= "â³ *Menunggu Verifikasi Tendik:* {$pendingTendik}\n";
        $message .= "â³ *Menunggu Persetujuan Dekan:* {$pendingDekan}\n";
        $message .= "âœ… *Disetujui Hari Ini:* {$approvedToday}\n";
        $message .= "âŒ *Ditolak Hari Ini:* {$rejectedToday}\n\n";
        $message .= "ðŸ”— [Dashboard E-Dokumen](" . url('/dokumen/dashboard') . ")";

        return $this->sendMessage($message);
    }

    public function testConnection()
    {
        $message = "ðŸ¤– *Test Koneksi Bot Telegram*\n\n";
        $message .= "âœ… Bot FMIPA USB berhasil terhubung!\n";
        $message .= "ðŸ“… " . now()->format('d M Y H:i:s') . "\n\n";
        $message .= "ðŸ”” Notifikasi sistem verifikasi surat aktif.";

        return $this->sendMessage($message);
    }

    public function testDocumentSend($filePath)
    {
        $caption = "ðŸ“„ *Test Pengiriman Dokumen*\n";
        $caption .= "ðŸ“… " . now()->format('d M Y H:i:s') . "\n";
        $caption .= "ðŸ§ª Testing document send functionality";

        return $this->sendDocument($filePath, $caption);
    }
}
